name: Test CachyOS Installations

on:
  push:
    branches: [ main, master, clean_up ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test-installations:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        # Test different shells and scenarios
        test-set: [core, full]
    
    container:
      image: archlinux:latest
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Update system and install base dependencies
      run: |
        pacman -Syu --noconfirm
        pacman -S --needed --noconfirm \
          base base-devel \
          git curl wget \
          fish sudo which \
          openssl zlib bzip2
      
    - name: Configure sudo for GitHub Actions user
      run: |
        echo 'root ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
        echo 'github ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers
      
    - name: Create non-root user for testing
      run: |
        useradd -m -G wheel github
        echo 'github ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers.d/github
        chmod 0440 /etc/sudoers.d/github
      
    - name: Make all scripts executable
      run: |
        chmod +x *.fish
      
    - name: Test Core Installations (Matrix: core)
      if: matrix.test-set == 'core'
      run: |
        runuser -l github -c 'cd /__w/CachyOS-Setup && ./git_setup.fish' &
        sudo -u github bash -c 'cd /__w/CachyOS-Setup && ./htop.fish' &
        sudo -u github bash -c 'cd /__w/CachyOS-Setup && ./netcat.fish' &
        wait
        
        # Verify installations
        which htop nc
        
    - name: Test Full Installation (Matrix: full)
      if: matrix.test-set == 'full'
      run: |
        # Run installations as the GitHub user
        cd /__w/CachyOS-Setup
        
        # Core system utilities
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./htop.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./netcat.fish' || true
        
        # Containers
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./podman.fish' || true
        
        # Browsers
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./chromium.fish' || true
        
        # Editors (with timeout to avoid hanging)
        timeout 300 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./cursor.fish' || true
        timeout 300 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./emacs.fish' || true
        timeout 300 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./doom_emacs.fish' || true
        
        # Language tools
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./mise.fish' || true
        timeout 600 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./elixir_and_erlang.fish' || true
        
        # Communication tools
        timeout 300 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./postman.fish' || true
        timeout 300 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./slack.fish' || true
        timeout 300 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./webcord.fish' || true
        
        # Networking
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./wireshark.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./wrk.fish' || true
        
        # Cloud/Infrastructure
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./cuda.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./dbeaver.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./kubectl.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./ngrok.fish' || true
        
        # AI & Media
        timeout 300 runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./ollama.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./vlc.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./pdf_support.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./exiftool.fish' || true
        runuser -l github -c 'cd /__w/CachyOS-Setup && yes | ./vivaldi.fish' || true
        
    - name: Verify installations
      run: |
        echo "=== Verifying installations ==="
        
        # Check basic tools
        echo "Checking basic tools..."
        which htop && echo "✓ htop" || echo "✗ htop"
        which nc && echo "✓ netcat" || echo "✗ netcat"
        which vim || which nano && echo "✓ editor" || echo "✗ editor"
        
        # Check if installations created expected directories/files
        echo "Checking for installed tools..."
        ls -la ~/.local/bin/ 2>/dev/null || echo "~/.local/bin doesn't exist yet"
        ls -la ~/.config/ 2>/dev/null || echo "~/.config doesn't exist yet"
        
    - name: Test healthcheck
      continue-on-error: true
      run: |
        if [ -f Makefile ]; then
          cd /__w/CachyOS-Setup
          make healthcheck || echo "Healthcheck completed with some failures (expected in CI)"
        fi
      
    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: installation-logs
        path: |
          /tmp/*.log
          /var/log/*
        if-no-files-found: ignore
        retention-days: 7

