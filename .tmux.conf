# === .tmux.conf ===
# Purpose: Tmux configuration optimized for Elixir Phoenix development
# Compatible with Doom Emacs (Evil mode) - no keybinding conflicts
# Author: theoneandonlywoj

# ============================================================
# GENERAL SETTINGS
# ============================================================

# Change prefix from Ctrl+b to Ctrl+a (closer to home row)
# Note: Safe for Doom Emacs users - Evil mode uses 0/^ for line start
unbind C-b
set -g prefix C-a
bind C-a send-prefix  # Send Ctrl+a to terminal with Ctrl+a Ctrl+a

# Enable mouse support (selection, scrolling, pane resizing)
set -g mouse on

# Start windows and panes at 1, not 0 (matches keyboard layout)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Large scrollback buffer for Phoenix logs
set -g history-limit 50000

# Faster command sequences (critical for Evil mode escape)
set -sg escape-time 0

# Increase repeat time for repeatable commands
set -g repeat-time 300

# Focus events for Emacs auto-save and other applications
set -g focus-events on

# Activity monitoring
setw -g monitor-activity on
set -g visual-activity off

# Don't rename windows automatically
set -g allow-rename off

# ============================================================
# DISPLAY / COLORS
# ============================================================

# True color support for doom-one theme and IEx syntax highlighting
set -g default-terminal "tmux-256color"
set -sa terminal-overrides ",xterm*:Tc"
set -sa terminal-overrides ",alacritty:Tc"
set -sa terminal-overrides ",kitty:Tc"

# Status bar position
set -g status-position bottom

# Status bar style
set -g status-style 'bg=#282c34 fg=#bbc2cf'
set -g status-left-length 40
set -g status-right-length 60

# Status bar content
set -g status-left '#[fg=#98be65,bold] #S #[fg=#5B6268]│ '
set -g status-right '#[fg=#5B6268]│ #[fg=#da8548]%H:%M #[fg=#5B6268]│ #[fg=#51afef]%d-%b-%Y '

# Window status
setw -g window-status-format '#[fg=#5B6268] #I:#W '
setw -g window-status-current-format '#[fg=#51afef,bold] #I:#W '
setw -g window-status-separator ''

# Pane borders
set -g pane-border-style 'fg=#3f444a'
set -g pane-active-border-style 'fg=#51afef'

# Message style
set -g message-style 'bg=#282c34 fg=#bbc2cf bold'

# ============================================================
# KEY BINDINGS - WINDOWS
# ============================================================

# Create new window (keep current path)
bind c new-window -c "#{pane_current_path}"

# Window navigation
bind n next-window
bind p previous-window
bind Tab last-window

# Quick window switching with numbers
bind 1 select-window -t 1
bind 2 select-window -t 2
bind 3 select-window -t 3
bind 4 select-window -t 4
bind 5 select-window -t 5
bind 6 select-window -t 6
bind 7 select-window -t 7
bind 8 select-window -t 8
bind 9 select-window -t 9

# Rename window
bind , command-prompt -I "#W" "rename-window '%%'"

# ============================================================
# KEY BINDINGS - PANES
# ============================================================

# Intuitive split bindings (keep current path)
bind | split-window -h -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"  # Alternative without shift
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"  # Alternative with shift

# Vim-style pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Vim-style pane resizing (uppercase)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Fine-grained resizing with Alt+arrow (no prefix needed)
bind -n M-Left resize-pane -L 2
bind -n M-Right resize-pane -R 2
bind -n M-Up resize-pane -U 2
bind -n M-Down resize-pane -D 2

# Zoom pane (toggle fullscreen)
bind z resize-pane -Z

# Close pane (with confirmation)
bind x confirm-before -p "Kill pane #P? (y/n)" kill-pane

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Synchronize panes (type in all panes simultaneously)
bind y setw synchronize-panes \; display "Sync: #{?synchronize-panes,ON,OFF}"

# ============================================================
# KEY BINDINGS - SESSIONS
# ============================================================

# Session management
bind s choose-tree -Zs  # List sessions
bind S command-prompt -p "New session name:" "new-session -s '%%'"
bind $ command-prompt -I "#S" "rename-session '%%'"

# Detach
bind d detach-client

# Switch to last session
bind ( switch-client -p
bind ) switch-client -n

# ============================================================
# KEY BINDINGS - COPY MODE (Vi-style)
# ============================================================

# Use vi keys in copy mode
setw -g mode-keys vi

# Enter copy mode
bind Enter copy-mode
bind [ copy-mode

# Vi-style copy mode bindings
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi Escape send -X cancel

# Rectangle selection
bind -T copy-mode-vi r send -X rectangle-toggle

# Scroll in copy mode
bind -T copy-mode-vi C-u send -X halfpage-up
bind -T copy-mode-vi C-d send -X halfpage-down

# Search
bind -T copy-mode-vi / command-prompt -i -p "Search down:" "send -X search-forward-incremental \"%%%\""
bind -T copy-mode-vi ? command-prompt -i -p "Search up:" "send -X search-backward-incremental \"%%%\""

# ============================================================
# KEY BINDINGS - UTILITY
# ============================================================

# Reload configuration
bind r source-file ~/.tmux.conf \; display "Config reloaded!"

# Clear history
bind C-l send-keys C-l \; clear-history

# Toggle status bar
bind b set -g status

# ============================================================
# PHOENIX DEVELOPMENT LAYOUTS
# ============================================================

# Phoenix dev layout: Editor left, server top-right, IEx bottom-right
bind P split-window -h -c "#{pane_current_path}" \; \
       split-window -v -c "#{pane_current_path}" \; \
       select-pane -t 1 \; \
       send-keys -t 2 "mix phx.server" \; \
       send-keys -t 3 "iex -S mix" \; \
       display "Phoenix layout ready"

# Test layout: Editor left, test watcher right
bind T split-window -h -c "#{pane_current_path}" \; \
       select-pane -t 1 \; \
       send-keys -t 2 "mix test --stale --listen-on-stdin" \; \
       display "Test layout ready"

# ============================================================
# PLUGINS (TPM - Tmux Plugin Manager)
# ============================================================

# Plugin list
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'

# Plugin settings
# Resurrect: save and restore sessions
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'

# Continuum: auto-save sessions
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Yank: system clipboard integration
set -g @yank_selection_mouse 'clipboard'

# ============================================================
# INITIALIZE TPM
# ============================================================

# Install TPM if not present:
#   git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
#
# Install plugins: prefix + I
# Update plugins:  prefix + U
# Clean plugins:   prefix + alt + u

run -b '~/.tmux/plugins/tpm/tpm'
